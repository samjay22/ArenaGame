name: CI/CD Pipeline

on:
  push:
    branches:
      - Prod
      - Stage
      - Dev

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    # Dynamically set the environment based on the branch name
    environment: ${{ github.ref_name == 'Prod' && 'Production' || github.ref_name == 'Stage' && 'Staging' || github.ref_name == 'Dev' && 'Development' }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Install Luau
        uses: EncodedVenom/install-luau@v4.3
        with:
          verbose: false
          version: latest

      - name: Install Luau Type Checker
        run: |
          curl -L https://github.com/Roblox/luau/releases/download/0.543/luau-linux.tar.gz | tar xz
          sudo mv luau /usr/local/bin/luau-analyze

      - name: Run Luau Type Checker
        run: |
          luau-analyze .
        continue-on-error: false

      - name: Upload to Roblox
        uses: Ulferno/upload-to-roblox@v1.0.4
        with:
          # Pulling secrets from the environment
          api-key: ${{ secrets.API_KEY }}
          universeId: ${{ secrets.UNIVERSE_ID }}
          placeId: ${{ secrets.PLACE_ID }}
          file: ${{ secrets.FILE_PATH }}
          # Optionally set shouldPublish from a secret or default to true
          shouldPublish: ${{ secrets.SHOULD_PUBLISH || 'true' }}
